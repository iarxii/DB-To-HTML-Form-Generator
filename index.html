<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Generator Version 0.1</title>

    <!-- bootstrap css 5.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <!-- w3 animate -->
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

    <!-- jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- base.css styles -->
    <link rel="stylesheet" href="css/base.css">

    <!-- object-styles.css styles -->
    <link rel="stylesheet" href="css/object-styles.css">

    <!-- code_editing.css style -->
    <link rel="stylesheet" href="css/code_editing.css">

    <!-- Include Prism CSS -->
    <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css" rel="stylesheet" /> -->
    <link href="./node_modules/prismjs/themes/prism.css" rel="stylesheet" />


</head>

<body>
    <div id="snackbar" class="snackbar"></div>
    <div id="root" class="container-fluid">
        <div class="row">
            <div class="col-md-4">
                <!-- design pallete window -->
                <h5 class="fs-1">Tools</h5>
                <div class="design-tools-panel mb-4" style="max-height: 209px;" id="design-pallete-container">
                    <div class="row">
                        <div class="col-sm">
                            <p class="fs-5">Database Config.</p>
                        </div>
                        <div class="col-sm">
                            <p class="fs-5">Form Style.</p>
                            <!-- select the form style -->
                            <div class="input-group">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="formStyleOptions"
                                        id="inlineRadiobtn" value="inline">
                                    <label class="form-check-label" for="inlineRadiobtn">inline</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="formStyleOptions"
                                        id="gridRadiobtn" value="grid">
                                    <label class="form-check-label" for="gridRadiobtn">grid</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm">
                            <p class="fs-5">CSS Styling</p>
                        </div>
                        <div class="col-sm">
                            <p class="fs-5">Elements</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm">
                            <p class="fs-5">Reorder</p>
                        </div>
                        <div class="col-sm">
                            <p class="fs-5">Reload</p>
                        </div>
                    </div>
                </div>

                <!-- db table list -->
                <div class="material-rounded-panel mb-4" style="max-height: 66vh;" id="dbtables-list-container">
                    <div class="text-center">
                        <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status">
                            <span class="visually-hidden">Waiting for list...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <!-- review output window -->
                <h5 class="fs-1">Preview</h5>
                <div class="material-rounded-panel" id="preview-output-container">
                    <!-- bootstrap tabs -->
                    <ul class="nav nav-tabs sticky-top m-0 bg-white rounded-2" style="overflow: hidden;" id="myTab"
                        role="tablist">
                        <li class="nav-item" role="presentation" id="tabDesign">
                            <a class="nav-link fs-bold active" id="design-tab" data-bs-toggle="tab"
                                data-bs-target="#design-panel" role="tab" aria-controls="design-panel"
                                aria-selected="true">Form view.</a>
                        </li>
                        <li class="nav-item" role="presentation" id="tabHTML">
                            <a class="nav-link fs-bold" id="html-tab" data-bs-toggle="tab" data-bs-target="#html-panel"
                                role="tab" aria-controls="html-panel" aria-selected="false">HTML.</a>
                        </li>
                        <li class="nav-item" role="presentation" id="tabJS">
                            <a class="nav-link fs-bold" id="js-tab" data-bs-toggle="tab" data-bs-target="#js-panel"
                                role="tab" aria-controls="js-panel" aria-selected="false">Javascript.</a>
                        </li>
                    </ul>
                    <div class="tab-content" id="myTabContent">
                        <!-- design tab -->
                        <div class="tab-pane fade show active" id="design-panel" role="tabpanel"
                            aria-labelledby="home-tab">
                            <span class="visually-hidden">Design</span>
                            <div class="design-preview w3-animate-left" id="design-output">
                                <p class="text-center py-5">No preview available</p>
                            </div>
                        </div>
                        <!-- html tab -->
                        <div class="tab-pane fade" id="html-panel" role="tabpanel" aria-labelledby="profile-tab">
                            <span class="visually-hidden">HTML</span>
                            <!-- function seperator accordion -->
                            <div class="accordion accordion-flush" id="accordionFlushHTML">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button btn btn-primary fw-bold fs-5" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#flush-collapseOne"
                                            aria-expanded="true" aria-controls="flush-collapseOne">
                                            View form code.
                                        </button>
                                    </h2>
                                    <div id="flush-collapseOne" class="accordion-collapse collapse show"
                                        data-bs-parent="#accordionFlushExample">
                                        <div class="accordion-body">

                                            <!-- html output text container -->
                                            <div class="code-block">
                                                <pre><code id="html-preview" class="language-html"> 
                                                    <p> Select a table. </p> 
                                                </code></pre>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button btn btn-primary fw-bold fs-5 collapsed"
                                            type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwo"
                                            aria-expanded="false" aria-controls="flush-collapseTwo">
                                            Edit form code.
                                        </button>
                                    </h2>
                                    <div id="flush-collapseTwo" class="accordion-collapse collapse"
                                        data-bs-parent="#accordionFlushExample">
                                        <div class="accordion-body">

                                            <div class="d-grid" style="height: 400px;position: relative;">
                                                <!-- html code editor -->
                                                <pre id="html-editing" class="highlighting" aria-hidden="true">
                                                    <code id="html-editing-highlighting" class="language-html"></code>
                                                </pre>
                                                <textarea class="editing" id="html-output" spellcheck="false"
                                                    oninput="sync_scroll(this,'#html-editing');"
                                                    onscroll="sync_scroll(this,'#html-editing');"></textarea>
                                                <!-- oninput="editorUpdate(this.value);" -->
                                                <!-- ./ html code editor -->
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- js tab -->
                        <div class="tab-pane fade" id="js-panel" role="tabpanel" aria-labelledby="contact-tab">
                            <span class="visually-hidden">Javascript</span>
                            <!-- function seperator accordion -->
                            <div class="accordion accordion-flush" id="accordionFlushJS">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button btn btn-primary fw-bold fs-5" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#flush-collapseOne"
                                            aria-expanded="true" aria-controls="flush-collapseOne">
                                            View form code.
                                        </button>
                                    </h2>
                                    <div id="flush-collapseOne" class="accordion-collapse collapse show"
                                        data-bs-parent="#accordionFlushExample">
                                        <div class="accordion-body">

                                            <!-- js output text container -->
                                            <div class="code-block">
                                                <pre><code id="js-preview" class="language-javascript"></code></pre>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button btn btn-primary fw-bold fs-5 collapsed"
                                            type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwo"
                                            aria-expanded="false" aria-controls="flush-collapseTwo">
                                            Edit form code.
                                        </button>
                                    </h2>
                                    <div id="flush-collapseTwo" class="accordion-collapse collapse"
                                        data-bs-parent="#accordionFlushExample">
                                        <div class="accordion-body">

                                            <div class="d-grid" style="height: 400px;position: relative;">
                                                <!-- js code editor -->
                                                <pre id="js-editing" class="highlighting" aria-hidden="true">
                                                    <code id="js-editing-highlighting" class="language-javascript"></code>
                                                </pre>
                                                <textarea class="editing" id="js-output" spellcheck="false"
                                                    oninput="sync_scroll(this,'#js-editing');"
                                                    onscroll="sync_scroll(this,'#js-editing');"></textarea>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    <!-- ./ bootstrap tabs -->
                </div>
            </div>
        </div>
    </div>

    <script>
        function sync_scroll(element, scrollElement) {
            /* Scroll result to scroll coords of event - sync with textarea */
            let result_element = document.querySelector(scrollElement);
            // Get and set x and y
            result_element.scrollTop = element.scrollTop;
            result_element.scrollLeft = element.scrollLeft;
        }

        // jquery
        $(document).ready(function () {
            // load design pallete
            // $("#design-pallete-container").load("design-pallete.php");
            // load preview output
            // $("#preview-output-container").load("preview-output.php");

            // PREVIEW_FORM_STYLE is used to determine what the default form structure is: inline or grid (input labels and input form are placed in a row object) style
            // check if PREVIEW_FORM_STYLE is set in localstorage
            var previewFormStyle = localStorage.getItem("PREVIEW_FORM_STYLE");
            if (previewFormStyle == null) {
                // set it to the default structure: inline
                localStorage.setItem("PREVIEW_FORM_STYLE", "inline");
                previewFormStyle = "inline";
            } else {
                previewFormStyle = localStorage.getItem("PREVIEW_FORM_STYLE");
            }

            if (previewFormStyle == "inline") {
                document.getElementById("inlineRadiobtn").checked = true;
                document.getElementById("gridRadiobtn").checked = false;
            } else {
                document.getElementById("inlineRadiobtn").checked = false;
                document.getElementById("gridRadiobtn").checked = true;
            }

            // show snackbar
            $.showSnackbar = function (message) {
                // Get the snackbar DIV
                var x = document.getElementById("snackbar");

                // Add the "show" class to DIV
                x.className = "show";
                x.innerHTML = message;

                // After 5 seconds, remove the show class from DIV
                setTimeout(function () {
                    x.className = x.className.replace("show", "");
                }, 5000);
            }



            $.compileDesignPallete = function () {
                // 1. get function call get_db_table_names.php and output to #design-pallete-container
                $.get("scripts/php/form_generation/get_db_table_names.php", function (data) {
                    if (data == "error" || data == "") {
                        alert("Error: " + data);
                        console.log(
                            "get request has failed calling [get_db_table_names.php]: \n[Status]: " +
                            status + "\n[Data]: " + data
                        );
                        $("#dbtables-list-container").html("<p class='text-center'>Error loading design pallete</p>");
                    } else {
                        $("#dbtables-list-container").html(data);
                    }
                });

            }


            $.compileFormPreview = function (tableName) {
                // set the table name in localstorage
                let previewFormStyle = localStorage.setItem("DB_TABLE_NAME", tableName);

                // get the initial form design preview
                $.get("scripts/php/form_generation/generate_form_from_dbtable.php?tblname=" + tableName + "&style=" + previewFormStyle, function (data) {
                    if (data == "error" || data == "") {
                        alert("Error: " + data);
                        console.log(
                            "get request has failed calling [generate_form_from_dbtable.php]: \n[Status]: " +
                            status + "\n[Data]: " + data
                        );

                        // push error message to #design-output
                        $("#design-output").html("<p class='text-center'>Error loading design preview</p>");

                        // push error message to #html-output
                        $("#html-output").val("Error loading design preview");

                        // call Prism to highlight the code
                        $.compilePrismOutputHTML("Error loading design preview");
                    } else {
                        // to see the form design output
                        $("#design-output").html(data);

                        // to see the html output
                        $("#html-output").val(data);

                        // call Prism to highlight the code
                        $.compilePrismOutputHTML(data);
                    }
                });

                // 3. get function call generate_form_jquery_from_dbtable.php.php?req=js and output to #js-preview
                $.get("scripts/php/form_generation/generate_form_jquery_from_dbtable.php?tblname=" + tableName, function (data) {
                    if (data == "error" || data == "") {
                        alert("Error: " + data);
                        console.log(
                            "get request has failed calling [generate_form_jquery_from_dbtable.php.php]: \n[Status]: " +
                            status + "\n[Data]: " + data
                        );

                        $("#js-output").val("Error loading form jquery");
                        // $("#js-preview").text("<p class='text-center'>Error loading form jquery</p>");
                        $.compilePrismOutputJavascript("Error loading form jquery");
                    } else {
                        $("#js-output").val(data);
                        // $("#js-preview").text(data);
                        $.compilePrismOutputJavascript(data);
                    }
                });

                // show snackbar with message
                $.showSnackbar("Form preview generated for table: " + tableName + "");
            }

            function editorUpdate(input, language, outputid) {
                // Handle final newlines (see article)
                if (input[input.length - 1] == "\n") { // If the last character is a newline character
                    input += " "; // Add a placeholder space character to the final line 
                }

                // Get the HTML code
                var htmlCode = input //document.getElementById('html-editing-input').value;

                var indentedHtmlCode;

                result_element = document.getElementById(outputid);

                switch (language) {
                    case "html":
                        // Indent and add syntax highlighting
                        indentedHtmlCode = Prism.highlight(htmlCode, Prism.languages.markup, 'markup');
                        break;
                    case "js":
                        // Indent and add syntax highlighting
                        indentedHtmlCode = Prism.highlight(htmlCode, Prism.languages.javascript, 'javascript');
                        break;
                    default:
                        // Indent and add syntax highlighting
                        indentedHtmlCode = Prism.highlight(htmlCode, Prism.languages.markup, 'markup');
                        break;
                }

                // Add the indented and highlighted code to the preview container
                // result_element.innerHTML = indentedHtmlCode; 
                result_element.innerHTML = indentedHtmlCode.replace(new RegExp("&", "g"), "&").replace(new RegExp("<", "g"), "<"); /* Global RegExp */

                // Syntax Highlight
                Prism.highlightElement(result_element);

            }


            $.compilePrismOutputHTML = function (input) {

                //*** copilot chat:
                // Get the HTML code
                var htmlCode = input //document.getElementById('html-output').value;

                // Indent and add syntax highlighting
                var indentedHtmlCode = Prism.highlight(htmlCode, Prism.languages.markup, 'markup');

                // Add the indented and highlighted code to the preview container
                document.getElementById('html-preview').innerHTML = indentedHtmlCode;
                // Add the indented and highlighted code to the text editing container
                editorUpdate(htmlCode, "html", "html-editing-highlighting");
            }

            $.compilePrismOutputJavascript = function (input) {

                //*** copilot chat:
                // Get the HTML code
                var jsCode = input //document.getElementById('js-output').value;

                // Indent and add syntax highlighting
                var indentedHtmlCode = Prism.highlight(jsCode, Prism.languages.javascript, 'javascript');

                // Add the indented and highlighted code to the preview container
                document.getElementById('js-preview').innerHTML = indentedHtmlCode;
            }

            // jquery event listener for #html-output on keyup
            $("#html-output").keyup(function () {
                // get the html output
                var htmlOutput = $("#html-output").val();
                // set the html preview
                $("#html-preview").text(htmlOutput);
                // update html text editor inputs content
                editorUpdate(htmlOutput, "html", "html-editing-highlighting");
                // compile prism
                Prism.highlightAll();
                // update #design-utput with the html output
                $("#design-output").html(htmlOutput);
            });

            // jquery event listener for #js-output on keyup
            $("#js-output").keyup(function () {
                // get the js output
                var jsOutput = $("#js-output").val();
                // set the js preview
                $("#js-preview").text(jsOutput);
                // update html text editor inputs content
                // editorUpdate(htmlOutput, "js", "js-editing-highlighting");
                $('#html-editing-highlighting').text(jsOutput);
                // compile prism
                Prism.highlightAll();
            });

            // jquery event listener for #inlineRadiobtn radio button
            $("#inlineRadiobtn").click(function () {
                // set the preview form style to inline
                localStorage.setItem("PREVIEW_FORM_STYLE", "inline");
                // get the table name from localstorage
                var tableName = localStorage.getItem("DB_TABLE_NAME");
                if (tableName == null) {
                    // error: table name is not set in localstorage
                    alert("Error: table name is not set in localstorage");
                } else {
                    // compile the table preview
                    $.compileFormPreview(tableName);
                }
            });

            // jquery event listener for #gridRadiobtn radio button
            $("#gridRadiobtn").click(function () {
                // set the preview form style to grid
                localStorage.setItem("PREVIEW_FORM_STYLE", "grid");
                // get the table name from localstorage
                var tableName = localStorage.getItem("DB_TABLE_NAME");
                if (tableName == null) {
                    // error: table name is not set in localstorage
                    alert("Error: table name is not set in localstorage");
                } else {
                    // compile the table preview
                    $.compileFormPreview(tableName);
                }

            });


            // jquery event listener for #html-output change
            // $("#html-output").change(function () {
            //     // get the html output
            //     var htmlOutput = $("#html-output").val();
            //     // set the html preview
            //     $("#html-preview").text(htmlOutput);
            //     // compile prism
            //     Prism.highlightAll();
            // });

            // jquery event listener for #js-output change
            // $("#js-output").change(function () {
            //     // get the js output
            //     var jsOutput = $("#js-output").val();
            //     // set the js preview
            //     $("#js-preview").text(jsOutput);
            //     // compile prism
            //     Prism.highlightAll();
            // });


            // initialize the design pallete
            $.compileDesignPallete();
        });
    </script>

    <!-- bootstrap js 5.3 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <!-- Include Prism JS -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-markup.min.js"></script> -->
    <script src="./node_modules/prismjs/prism.js"></script>

</body>

</html>